name: CI - Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      # --- Checkout repo ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Set up Docker Buildx (multi-platform builder) ---
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # --- Cache Docker layers (for faster builds) ---
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # --- Build the Flask image ---
      - name: Build Flask image
        run: |
          docker build -t flask-devops-hybrid-template:ci -f app/Dockerfile app

      # --- Run the container for test ---
      - name: Run container
        run: |
          docker run -d --rm -p 5000:5000 --name flaskr_ci flask-devops-hybrid-template:ci
          sleep 10
          curl -f http://localhost:5000/metrics || (echo "Flask healthcheck failed" && exit 1)

      # --- Stop container after test ---
      - name: Stop container
        if: always()
        run: docker stop flaskr_ci
